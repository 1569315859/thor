到这里虚拟机监视器就会发送一个ACK包说自己收到输入
直到主节点接收到ACK包时
虚拟机监视器才会将包发送到网络中
所以这个方案就是 若客户端可以收到回复
那么副节点肯定也收到过请求 并且至少已经存到缓冲区
因此我们不在会有以下的异常
客户端已经收到了回复 然后因为有故障发生
副节点完全没有接到过相关内容
比如说有些情况消息可能会中途丢失
日志记录丢失后主节点宕机
因为消息没投递成功 所以副节点也没有确认
如果主节点宕机
日志记录随主节点宕机丢失
它肯定在虚拟机监视器发送输出包之前丢失
客户端不可能提前收到回复
它们也不会识别出异常发生
所以我们需要有输出规则进行限制

我不了解 论文没有谈到虚拟机监视器的实现
这是非常底层的知识
像划分内存空间 计算页表
与设备驱动交互 拦截指令
搞明白Guest用户执行的命令等
所以这是一些底层的东西 一般用C或C++编写的
但我并不了解
回到这里 主节点需要延迟回复
先等副节点确认已经收到最新消息
这是几乎所有主备复制模式性能的一道坎
这种同步等待让主节点不会领先于副节点太多
因为如果主节点在领先的情况下出现故障
副节点就会出现数据延迟
副节点的进度和客户端会不一致
所以每种主备系统都有这样的问题
某个时间主节点必须等待副节点
这是对性能实打实的限制
即使机器是在相邻机架上
主节点发送消息和接收确认
仍然需要等上0.5毫秒
如果说像避免像地震 大范围断电等问题
主副节点必须位于不同的城市
那延迟大概会增加到5毫秒
如果我们主副节点在不同城市进行复制
每一个发送的包
都需要等上5毫秒让日志记录到达副节点上
然后响应确认 最后才能发送回复给客户端
对于一些可靠性要求低的服务 可能并不成问题
但是对于一些数据库服务
比如需要每秒处理百万请求
那将会对性能有极大的影响
这也时在条件允许的情况下
人们会使用一些不同的主副复制模式
比如说在更高层次操作 并且需要解析操作内容
然后不需要每个包都等待确认
比如只在进行高层次操作时才等待
只读操作完全不需要等待
只需要等待写操作同步或者其他一些操作
但你需要在应用层上实现这些区分
你说的都是对的
虚拟机监视器不需要阻止主节点执行命令
只需要阻止输出就好
这可能可以做得更好
但至少这样在一个服务中
可以在几微秒内响应客户端
如果我们要先等待处于另一个城市的副节点响应
那可能会让10微秒变成10毫秒
如果你有大量客户端并发请求
虽然可能在高延迟下完成大量处理
但是你需要非常巧妙的设计才能做到
这是个很好的想法
但是如果你将消息记录到主节点内存中
在主节点宕机时日志就会丢失
通常认为服务器失效就意味着
服务器内存中的内容都会丢失
或者即使你不会如此
比如说失效是因为主节点电源被意外拔掉
但你有备用电源之类
你也做不到
副节点也做不到如此
实际上系统在副节点的内存中记录了输出
为了保证可靠记录 你必须遵守输出规则 等待确认
所以这是个正确的想法 但是不能使用主节点内存来做
再说一遍?
这个想法很棒
他问的是 能否输入由主节点接收 输出由副节点发送
我完全没有想过
这或许可以
我不确定 这很有意思

还有一个可能出现的情况
主节点在输出已经发送出去之后宕机
客户端已经收到回复
然后主节点宕机
副节点的输入还在事件缓冲中
在副节点的虚拟机监视器种
还没有投递到真正的服务副本
副节点要顶替宕机的主节点
它首先要消费所有未处理的记录
以赶上主节点的进度
否则主副节点进度就会不一致
副节点在接管服务之前要先消费完记录
最后一条记录是客户端的请求
副节点会在它之后开始接管服务
在传递客户端请求的中断之后
这意味着副节点计数器自增到11
然后生成一个输出包 因为这时候它接管服务
所以生成输出 客户端会受到两个11回复
如果真的发生这种情况的话是不对的
如果是单服务器的话这不应该发生
好消息则是
如果服务间是使用TCP通信
请求和响应都是通过TCP通道传输
当副节点接管时
副节点的状态和主节点一致 知道所有TCP连接
还有所有的序列号
当它产生这个包时
它会产生和原来的包一样的序列号
客户端的TCP栈会认为这是个重复的包
在TCP层就会将它丢弃掉
而在用户层软件中永远不会看到重复包
所以这个系统中
你可以认为问题被意外解决了或者被巧妙处理了
但事实上对于所有能够进行切换的复制系统
也就是大部分的复制系统
很难将他们设计成
保证切换时不会有重复输出
你可以在两边都引发报错
然后在两边都不生成输出
但是这种做法很糟糕
或者你可以允许切换时有两次输出
总之没有办法可以保证只有一次输出
两边都引发报错或者允许可能的重复输出
某种程度上说 所有复制模式的客户端
都需要重复包的检测机制
在这里我们使用TCP 不然的话也需要其他实现